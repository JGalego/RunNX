# RunNX Formal Verification Makefile

.PHONY: all verify test clean check-why3 install-why3

# Default target
all: verify test

# Check if Why3 is installed
check-why3:
	@which why3 > /dev/null || (echo "‚ùå Why3 not found. Run 'make install-why3' to install it." && exit 1)
	@echo "‚úÖ Why3 found"

# Install Why3 via opam
install-why3:
	@echo "üì¶ Installing Why3..."
	@if ! which opam > /dev/null; then \
		echo "Installing opam first..."; \
		curl -fsSL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh | sh; \
	fi
	@opam init -y --disable-sandboxing || true
	@eval `opam config env` && opam install -y why3 alt-ergo
	@echo "‚úÖ Why3 installed successfully"

# Run formal verification
verify: check-why3
	@echo "üîç Running formal verification..."
	@cd formal && why3 prove -P alt-ergo tensor_specs.mlw || echo "‚ö†Ô∏è Some proofs failed"
	@cd formal && why3 prove -P alt-ergo neural_network_specs.mlw || echo "‚ö†Ô∏è Some proofs failed"
	@echo "‚úÖ Formal verification completed"

# Run property-based tests
test:
	@echo "üß™ Running property-based tests..."
	@cargo test formal --release
	@echo "‚úÖ Property-based tests completed"

# Run the verification script
verify-script:
	@echo "üêç Running Python verification bridge..."
	@cd formal && python3 verify.py

# Generate Why3 HTML report
report: check-why3
	@echo "üìä Generating verification report..."
	@cd formal && why3 session html .
	@echo "üìÅ Report generated in formal/_why3session/"

# Run static analysis
lint:
	@echo "üîç Running static analysis..."
	@cargo clippy -- -D warnings
	@cargo fmt --check

# Run benchmarks with verification
bench:
	@echo "‚ö° Running benchmarks with verification..."
	@cargo bench
	@echo "‚úÖ Benchmarks completed"

# Full verification suite
full-verify: lint verify test bench
	@echo "üéâ Full verification suite completed!"

# Clean build artifacts and verification outputs
clean:
	@echo "üßπ Cleaning up..."
	@cargo clean
	@rm -rf formal/_why3session/
	@rm -rf formal/__pycache__/
	@echo "‚úÖ Cleanup completed"

# Interactive Why3 IDE
ide: check-why3
	@echo "üöÄ Starting Why3 IDE..."
	@cd formal && why3 ide tensor_specs.mlw

# Help target
help:
	@echo "RunNX Formal Verification Commands:"
	@echo ""
	@echo "  make all           - Run verification and tests"
	@echo "  make install-why3  - Install Why3 and Alt-Ergo"
	@echo "  make verify        - Run formal verification only"
	@echo "  make test          - Run property-based tests only"
	@echo "  make verify-script - Run Python verification bridge"
	@echo "  make report        - Generate HTML verification report"
	@echo "  make lint          - Run static analysis"
	@echo "  make bench         - Run benchmarks"
	@echo "  make full-verify   - Run complete verification suite"
	@echo "  make ide           - Start Why3 IDE"
	@echo "  make clean         - Clean build artifacts"
	@echo "  make help          - Show this help"
